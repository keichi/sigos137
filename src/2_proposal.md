# 提案

## アーキテクチャの概要

本報告の提案手法の基本的な考え方は，MPIが送出する各パケットに通信パターン
をエンコードしたタグを付与し，タグに基いてネットワークでパケット制御することに
ある．図 \ref{fig:proposal-arch}に提案手法のアーキテクチャを示す．各計算ノード
は，ユーザ空間で1つ以上のMPIアプリケーションのプロセスを実行する．各MPIアプリ
ケーションはMPIライブラリを動的リンクする．カーネル空間にはタグ付けカーネルモ
ジュールが常駐し，実際のタグ付け処理を実行する．MPIライブラリとカーネルモ
ジュールは連携動作し，タグ付けに必要なMPIライブラリ内部の情報を共有する．

SDNコントローラは，MPIパケットのタグに基づいて，パケットを制御するフローエント
リを各スイッチのフローテーブルに登録する．スイッチはMPIパケットを受信すると
パケットのタグを読み取り，フローテーブルに従ってパケットを処理する．受信側の計
算ノードに隣接するスイッチは，計算ノードにパケットを転送する前に，タグを除去す
る．

![提案手法の全体像の概要\label{fig:proposal-arch}](proposal-arch.pdf)

## タグの格納場所の検討

提案手法では，タグをMPIパケットのMACアドレスフィールドに埋め込む．これはスイッ
チが，タグに基づくパケット制御を効率的に実行できるようにするための工夫である．
SDNスイッチが取り扱えるヘッダフィールドは，OpenFlow規格で定義されたフィールド
に限られる．事前定義されていないヘッダフィールドを読み取る場合は，SDNコント
ローラへパケットを転送する必要があり，オーバーヘッドが非常に大きい．従って，タ
グを埋め込むヘッダフィールドはOpenFlow規格で定義されている必要がある．MACアド
レスフィールドは，OpenFlow規格において定義されているヘッダフィールドである．

次に，スイッチに登録できるフローの数が増えるという利点がある．OpenFlowスイッチ
のフローテーブルに登録できるフローの数には制限があり，一般的なOpenFlowスイッチ
では数千個のオーダである．ところが，多くのOpenFlowスイッチはL2ヘッダフィールド
（MACアドレスとVLAN ID）のみ含むフローに関しては数万個登録できる．よって，タグ
をパケットをMACアドレスに格納すれば，フロー数の上限が増える．

## MACアドレスの書き換え方法

提案手法では，MPI通信パターンに応じて動的にタグ付けするので，動的にMPIパケット
のMACアドレスを書き換える必要がある．

動的にパケットのMACアドレスを変える方法として，Rawソケットを用いる方法がある．
Rawソケットは，ユーザ空間のプログラムからパケットのプロトコルヘッダを読み書き
可能にするソケットである．Rawソケットを用いれば，L2ヘッダのMACアドレスを自由に
変更してパケットを送信できる．一方で，TCP/IPスタックを全て再実装する必要があり
，非現実的である．また，MPIライブラリをRawソケットを使用するように大きく修正す
る必要があることや，アプリケーションがroot権限で実行されなければいけないなどの
欠点もある．

Linuxカーネルが提供するnetfilter APIは，パケットのフィルタリングや改変のために
一般的に用いられる．LinuxにおけるファイアーウォールやNATは，内部でnetfilterを
使用している．Netfilterは，カーネルのネットワークスタックの特定の場所にフック
し，独自の処理を挿入することを可能にする．しかし，フックできる場所は事前定義さ
れた場所に限られ，カーネルがパケットにL2ヘッダを付与するのは，それらのフック可
能な場所を通過した後である．そのため，netfilterではパケットのMACアドレスを書き
換えることはできない．

提案手法では，プロトコルハンドラを実装することでMACアドレスの書き換えを実現し
ている．プロトコルハンドラは，パケットがNIC（Network Interface Card）から到着
した直後と，NICへ送信される直前にカーネルが呼び出すコールバック関数である．プ
ロトコルハンドラは，カーネル空間で実行されるため，カーネルモジュール
\cite{Goyeneche1999}に実装する．プロトコルハンドラでは，NICへ送信するパケット
全体を取得し，書き換えることができるため，タグ付け機構を実装するために適してい
る．

## タグ付けカーネルモジュール

次に，MPIライブラリからタグ付けに必要な情報を取得する方法を検討する．

![2ノード間の帯域幅の比較\label{fig:bw-overhead}](bw.pdf)

![2ノード間の遅延の比較\label{fig:latency-overhead}](latency.pdf)

