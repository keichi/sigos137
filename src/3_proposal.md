# 提案

## 提案手法の概要

提案手法の基本的な考え方は，MPIが送出する各パケットに通信パターン
をエンコードしたタグを付与し，タグに基いてネットワークでパケット制御することに
ある．図 \ref{fig:proposal-arch}に提案手法の概要を示す．各計算ノード
は，ユーザ空間で1つ以上のMPIアプリケーションのプロセスを実行する．MPIアプリ
ケーションは，MPIライブラリを動的にリンクしている．計算ノードのカーネル空間に
は，「タグ付けカーネルモジュール」が常駐し，MPIライブラリが送出するパケットに
，タグ付け処理を実行する．MPIライブラリとカーネルモジュールは連携動作し，タグ
付けに必要なMPIライブラリ内部の情報を共有する．

SDNコントローラは，MPIパケットのタグに基いて，パケットを制御するフローエント
リを各スイッチのフローテーブルに登録する．スイッチはMPIパケットを受信すると
パケットのタグを読み取り，フローテーブルにしたがってパケットを処理する．受信側
の計算ノードに隣接するスイッチは，計算ノードにパケットを転送する前に，タグを除
去する．

![提案手法の概要\label{fig:proposal-arch}](proposal-arch.pdf)

タグ付けカーネルモジュールは，MPIというアプリケーションのレイヤの情報をSDNで取
り扱えるように，タグという形でパケットに埋め込む役割を担っている．パケット自身
にMPI通信パターンが書き込まれているため，SDNコントローラやスイッチは，MPIアプ
リケーションと別途通信することなく，各々のパケットに対する制御を決定
できる．本提案手法により，低オーバーヘッドなMPIアプリケーションとネット
ワーク制御の同期が可能になる．

## タグ付けカーネルモジュール

### タグの格納場所

提案手法では，タグに基くパケット制御を効率的に実行できるようにするため，タグ
をMPIパケットのMACアドレスフィールドに書き込む方法を選択した．この選択をした理
由は2つあり，SDNスイッチにおけるパケット転送処理のオーバーヘッドの削減と，フ
ロー数のスケーラビリティの向上である．

OpenFlowスイッチが取り扱えるヘッダフィールドは，OpenFlow規格で定義
されたフィールドに限られる．事前定義されていないヘッダフィールドを読み取る場合
は，毎回SDNコントローラへパケットを転送する必要があり，オーバーヘッドが非常に
大きい．そのため，タグは，OpenFlow規格で定義されていヘッダフィールドのいずれか
に埋め込むのが望ましい．MACアドレスフィールドは，OpenFlow規格において定義され
ているヘッダフィールドである．

さらに，スイッチに登録できるフローの数が増えるという利点がある．OpenFlowスイッ
チのフローテーブルに登録できるフローの数には上限があり，一般的なOpenFlowスイッ
チでは数千個のオーダである．しかし，多くのOpenFlowスイッチはL2ヘッダフィール
ド（MACアドレスとVLAN ID）のみ含むフローに関しては数万個登録できる．それゆえ，
タグをパケットをMACアドレスに格納することで，他のヘッダフィールドに格納するよ
りも，フロー数の上限を増やせる．

### MACアドレスの書き換え

パケットのアドレスフィールドを動的に変更する方法として，Rawソケットを用いる方
法，netfilter APIを用いる方法，プロトコルハンドラを用いる方法などがあるが，提
案手法ではプロトコルハンドラを用いる方法を選択した．以下にその理由を述べる．

Rawソケットは，ユーザ空間のプログラムからパケットのプロトコルヘッダを読み書き
可能にする特殊なソケットである．Rawソケットを用いれば，L2ヘッダを自由に構成し
てパケットを送信できる．一方で，ユーザ空間でTCP/IPスタックを全て再実装する必要
があり，非現実的である．また，MPIライブラリをRawソケットを使用するように大きく
修正する必要があることや，アプリケーションがroot権限で実行されなければいけない
などの欠点もある．

Linuxにおいて，パケットのフィルタリングや改変のためには，Linuxカーネルが提供す
るnetfilter APIが一般的に用いられる．実際，Linuxにおけるファイアーウォールや
NATは，内部でnetfilterを使用している．Netfilterは，プログラムがカーネルのネッ
トワークスタックの特定の場所にフックし，独自の処理を挿入することを可能にする．
しかし，フックできる場所は事前定義された場所に限られ，カーネルがパケットにL2
ヘッダを付与するのは，netfilterでフック可能な場所を通過した後である．そのため
，netfilterではパケットのMACアドレスを書き換えることはできない．

以上の議論を踏まえて，提案手法では，プロトコルハンドラを実装することでMACアド
レスの書き換えを実現している．プロトコルハンドラは，パケットがNIC（Network
Interface Card）から到着した直後と，NICへ送信される直前にカーネルが呼び出す
コールバック関数である．プロトコルハンドラは，カーネル空間で実行されるため，
カーネルモジュール\cite{Goyeneche1999}に実装する．プロトコルハンドラでは，NIC
へ送信するパケット全体を取得し，書き換えることができるため，タグ付けを実装でき
る．

### MPIパケットの識別

プロトコルハンドラは，カーネルのネットワークスタックが送出する全てのパケットに
ついて呼び出される．つまり，MPIライブラリ以外によって送信されたパケット，例え
ば計算ノードの制御に用いられるSSHのパケットについてもプロトコルハンドラが呼び
出される．よって，タグ付け処理の前段階として，プロトコルハンドラに渡されたパ
ケットがMPIライブラリに由来するものか判定しなければいけない．提案手法では，あ
るパケットがMPIに由来するかの判定条件として，それぞれのMPIプロセスの組について
一意に定まる，下記の4つ組を用いている：

- 送信元IPアドレス
- 宛先IPアドレス
- 送信元TCPポート番号
- 宛先TCPポート番号

以下では，この4つ組を「ピア情報」と呼ぶ．具体的な識別処理の手順は次の通りであ
る．MPIプロセス間でTCP接続が確立する度に，ピア情報をリストに追加していく．これ
を「ピアリスト」と呼ぶ．そして，プロトコルハンドラがパケットを受信すると，その
パケットからピア情報を抽出し，ピア情報がピアリストに含まれているか確認する．ピ
アリストに含まれていれば，パケットはMPIライブラリによって送出されたパケットで
あるから，タグ付け処理に続行する．ピアリストに含まれていなければ，単純に無視す
る．

### MPIライブラリとの連係

前節で述べたMPIパケットの識別方法では，タグ付けカーネルモジュールが，MPIプロ
セス間でTCP接続が確立したことをどのように検知するかという課題がある．提案手法
では，これをMPIライブラリとタグ付けカーネルモジュールの連係により実現する．具
体的には，MPIライブラリがMPIプロセス間でTCP接続を確立した際に，タグ付けカーネ
ルモジュールに前述のピア情報を通知する．本提案手法における各コンポーネントの相
互作用を，図\ref{fig:mpi-lkm}に示す．なお，実線はコンポーネントの連係を，点線
矢印はパケットの流れを表す．

ユーザ空間のプログラムとカーネルモジュールの間の通信には，`procfs`，`sysfs`，
netlinkソケット，`ioctl`システムコールなど様々な実現方法がある．ここでは，転送
するデータサイズが小さいことと，実装の容易さを考慮し，ここでは`ioctl`システム
コールを採用した．`ioctl`は，ユーザプログラムからデバイスドライバを制御するた
めのシステムコールである．

具体的な連係手順は次の通りである．タグ付けカーネルモジュールは，miscキャラクタ
デバイスとして振る舞い，`/dev/sdnmpi`にデバイスファイルを公開する．MPIライブラ
リは，初期化時に`/dev/sdnmpi`デバイスを開き，ファイルハンドルを保持しておく．
そして，MPIプロセス間でTCP接続が確立した際（`connect`あるいは`accept`関数成功
時）に，`/dev/sdnmpi`デバイスに対して`ioctl`システムコールを発行し，ピア情報を
引数として渡す．カーネルモジュール側では，`ioctl`システムコールのハンドラでピ
ア情報を受信し，ピアリストに追加する．

![タグ付けカーネルモジュールとMPIライブラリの連係\label{fig:mpi-lkm}](mpi-lkm.pdf)

## SDNコントローラ

本提案手法のSDNコントローラには，大きく分けて以下の3つの機能がある：

- MPIが送出するパケットのタグに基く制御
- MPI以外のアプリケーションが送出するパケットの制御
- 相互結合網のトポロジの把握

MPIが送出するパケットは，
\ref{ux30bfux30b0ux4ed8ux3051ux30abux30fcux30cdux30ebux30e2ux30b8ux30e5ux30fcux30eb}
節で説明したタグ付けカーネルモジュールにより，通信パターンを反映したタグが付与
される．SDNコントローラは，通信性能を向上させるように，タグにマッチして何らか
のアクションを実行するフローをSDNスイッチへフローをインストールする．通信パ
ターンからフローを生成する具体的なアルゴリズムは，拡張可能な仕組みになっている
．例えば，これまでにわれわれが開発した，SDN-MPI版の`MPI_Bcast`や
`MPI_Allreduce` \cite{Dashdavaa2013,Takahashi2014}などが考えられる．

相互結合網内には，SSHやNFSなど，MPI以外のアプリケーションが送出するパケットも
流れる．\ref{mpiux30d1ux30b1ux30c3ux30c8ux306eux8b58ux5225}節で述べた通り，こ
れらのパケットにはタグが付与されない．そのため，MPIが送出するパケットとは別に
扱う必要がある．まず，パケットの送信元MACアドレスと宛先MACアドレスから，送信元
計算ノードと宛先計算ノード間の経路を計算する．この際，複数の経路が可能な場合は
，リンクの負荷が分散されるように，1つ経路を選択する．最後に，経路に沿ってパ
ケットが転送されるように，選択した経路に含まれるSDNスイッチに，フローをインス
トールする．

上記の2つの機能を実現するためには，SDNコントローラが相互結合網のトポロジを正し
く把握する必要がある．提案手法では，LLDP（Link Layer Discovery Protocol）を用
いてトポロジの検出を実現している．各SDNスイッチに，自身の情報を含んだLLDPパ
ケットを定期的に送出させる．SDNスイッチがLLDPパケットを受信すると，LLDPパケッ
トを解析し，隣接するスイッチに関する情報を取得する．この手順を全スイッチについ
て行うことで，SDNスイッチの隣接リストを構築する．

